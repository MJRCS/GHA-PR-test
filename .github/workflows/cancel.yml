name: Cancel workflows

on:
  workflow_run:
    workflows: ["GHA-PR-test"]
    types:
      - requested

jobs:
  job1:
    name: Job 1
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codes
        uses: actions/checkout@v2

      - name: Use cancel redundant
        run: |
          echo "GITHUB_RUN_ID: ${GITHUB_RUN_ID}"
          echo "GITHUB_RUN_NUMBER: ${GITHUB_RUN_NUMBER}"
          echo "GITHUB_ACTION: ${GITHUB_ACTION}"
          echo "GITHUB_ACTOR: ${GITHUB_ACTOR}"
          echo "GITHUB_REPOSITORY: ${GITHUB_REPOSITORY}"
          echo "GITHUB_EVENT_NAME: ${GITHUB_EVENT_NAME}"
          echo "GITHUB_EVENT_PATH: ${GITHUB_EVENT_PATH}"
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE}"
          echo "GITHUB_SHA: ${GITHUB_SHA}"
          echo "GITHUB_REF: ${GITHUB_REF}"
          echo "GITHUB_HEAD_REF: ${GITHUB_HEAD_REF}"
          echo "GITHUB_BASE_REF: ${GITHUB_BASE_REF}"
          echo "GITHUB_API_URL: ${GITHUB_API_URL}"
          echo "====================================="
          cat ${GITHUB_EVENT_PATH}
          echo "====================================="
          export GITHUB_ACTOR
          export GITHUB_RUN_ID
          export GITHUB_HEAD_REF
          cd ${GITHUB_WORKSPACE}
          repo='https://api.github.com/repos/MJRCS/GHA-PR-test/actions/runs'
          cancel=$(curl -H "Accept: application/vnd.github.v3+json" ${repo} | ./json_helper.py cancel_workflow)
          echo ==============$cancel
          #cancel=$(echo $cancel | cut -d ' ' -f 2)
          #echo ==============$cancel
          if [[ $cancel != '' ]]; then
            for i in $cancel; do
              curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github.v3+json" ${repo}/$i/cancel
            done
          fi
